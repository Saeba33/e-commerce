{% extends 'base.html.twig' %}

{% block title %}Modifier le produit
{% endblock %}

{% block body %}
	<div class="container mx-auto px-4 py-6">
		<div class="content-container max-w-4xl mx-auto">

			<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
				<div>
					<h1 class="text-3xl font-bold text-gray-800 mb-2">
						Modifier le produit
					</h1>
					<p class="text-gray-600">Modifiez les informations de "{{ product.name }}"</p>
				</div>
			</div>

			{% include 'layouts/_flash_message.html.twig' %}

			<div class="card bg-white">
				<div class="card-body">
					{{ form_start(form) }}

					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
						<!-- Colonne gauche : Informations principales -->
						<div class="space-y-6">
							<div>
								{{ form_label(form.name, 'Nom du produit', {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-2'}}) }}
								{{ form_widget(form.name, {'attr': {'class': 'input-style input-style-common', 'placeholder': 'Saisissez le nom du produit'}}) }}
								<div class="m-1 text-red-500 text-sm">
									{{ form_errors(form.name) }}
								</div>
							</div>

							<div>
								{{ form_label(form.description, 'Description', {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-2'}}) }}
								{{ form_widget(form.description, {'attr': {'class': 'input-style input-style-common', 'rows': 4, 'placeholder': 'Décrivez votre produit en détail'}}) }}
								<div class="m-1 text-red-500 text-sm">
									{{ form_errors(form.description) }}
								</div>
							</div>

							<div>
								{{ form_label(form.image, 'Image du produit', {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-2'}}) }}

								<!-- Zone de téléchargement d'image personnalisée -->
								<div class="image-upload-container">
									<!-- Input file caché -->
									{{ form_widget(form.image, {'attr': {'class': 'hidden', 'accept': 'image/jpeg,image/png,image/jpg,image/webp'}}) }}

									<!-- Champ caché pour signaler la suppression d'image -->
									<input type="hidden" id="remove-image-flag" name="remove_image" value="0">

									<!-- Zone de drop personnalisée -->
									<div id="image-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-colors hover:border-blue-400 hover:bg-blue-50">

										<!-- Affichage de l'image actuelle -->
										<div id="current-image" class="{% if not product.image %}hidden{% endif %}">
											<p class="text-sm text-gray-600 mb-2">Image actuelle :</p>
											<img id="current-img" src="{% if product.image %}{{ asset('uploads/images/' ~ product.image) }}{% endif %}" alt="{{ product.name }}" class="mx-auto w-48 h-48 object-cover rounded-lg border border-gray-200 mb-2">
											<p class="text-xs text-gray-500 mb-2">Cliquez pour changer l'image</p>

											<!-- Bouton supprimer toujours visible quand il y a une image actuelle -->
											{% if product.image %}
												<div class="mt-3 flex justify-center">
													<button type="button" id="remove-current-image" class="inline-flex items-center gap-3 text-red-500 text-sm hover:text-red-700 px-4 py-2 border border-red-300 rounded-md hover:bg-red-50 w-56">
														<ion-icon name="trash-outline" class="text-base flex-shrink-0"></ion-icon>
														<span class="text-left whitespace-nowrap">Supprimer l'image</span>
													</button>
												</div>
											{% endif %}
										</div>

										<!-- Zone de placeholder (quand pas d'image) -->
										<div id="upload-placeholder" class="space-y-2 {% if product.image %}hidden{% endif %}">
											<ion-icon name="cloud-upload-outline" class="text-4xl text-gray-400"></ion-icon>
											<p class="text-sm font-medium text-gray-600">Cliquez ici pour ajouter une image</p>
											<p class="text-xs text-gray-500">ou glissez-déposez votre fichier</p>
											<p class="text-xs text-gray-400">Formats : JPEG, PNG, JPG, WEBP (max. 1MB)</p>
										</div>

										<!-- Aperçu de la nouvelle image sélectionnée -->
										<div id="image-preview" class="hidden">
											<p class="text-sm text-gray-600 mb-2">Nouvel aperçu :</p>
											<img id="preview-img" src="" alt="Aperçu" class="w-48 h-48 mx-auto rounded-lg shadow-md object-cover border border-gray-200 mb-2">
											<p id="image-name" class="text-sm text-gray-600 mb-3"></p>

											<!-- Boutons d'action pour la nouvelle image -->
											<div class="flex flex-col gap-2 items-center mt-3">
												<button type="button" id="remove-image-completely" class="inline-flex items-center gap-3 text-red-500 text-sm hover:text-red-700 px-4 py-2 border border-red-300 rounded-md hover:bg-red-50 w-56">
													<ion-icon name="trash-outline" class="text-base flex-shrink-0"></ion-icon>
													<span class="text-left whitespace-nowrap">Supprimer l'image</span>
												</button>
												{% if product.image %}
													<button type="button" id="cancel-modification" class="inline-flex items-center gap-3 text-gray-500 text-sm hover:text-gray-700 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 w-56">
														<ion-icon name="arrow-undo-outline" class="text-base flex-shrink-0"></ion-icon>
														<span class="text-left whitespace-nowrap">Annuler modification</span>
													</button>
												{% endif %}
											</div>
										</div>
									</div>
								</div>

								<div class="m-1 text-red-500 text-sm">
									{{ form_errors(form.image) }}
								</div>
							</div>
						</div>

						<!-- Colonne droite : Prix, stock et catégories -->
						<div class="space-y-6">
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
								<div>
									{{ form_label(form.price, 'Prix (€)', {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-2'}}) }}
									{{ form_widget(form.price, {'attr': {'class': 'input-style input-style-common', 'placeholder': '0.00'}}) }}
									<div class="m-1 text-red-500 text-sm">
										{{ form_errors(form.price) }}
									</div>
								</div>

								<div>
									{{ form_label(form.stock, 'Stock actuel', {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-2'}}) }}
									{{ form_widget(form.stock, {'attr': {'class': 'input-style-disabled', 'value': product.stock, 'readonly': true}}) }}
									<div class="m-1 text-red-500 text-sm">
										{{ form_errors(form.stock) }}
									</div>
								</div>
							</div>

							<div>
								{{ form_label(form.subCategories, 'Sous-catégories', {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-3'}}) }}
								<div class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-6">
									<div class="space-y-3">
										{% for choice in form.subCategories %}
											<div class="form-control">
												<label class="label cursor-pointer justify-start gap-3 p-2 hover:bg-gray-50 rounded transition-colors">
													{{ form_widget(choice, {'attr': {'class': 'checkbox checkbox-sm'}}) }}
													<span class="label-text text-sm text-gray-700">
														{{ choice.vars.label }}
													</span>
												</label>
											</div>
										{% endfor %}
									</div>
								</div>
								<div class="m-1 text-red-500 text-sm">
									{{ form_errors(form.subCategories) }}
								</div>
								<p class="text-xs text-gray-500 mt-1">Sélectionnez une ou plusieurs sous-catégories</p>
							</div>
						</div>
					</div>

					<!-- Boutons d'action -->
					<div class="border-t border-gray-200 pt-6 mt-8">
						<div class="flex flex-col sm:flex-row gap-4 justify-end">
							<a href="{{ path('app_product') }}" class="custom-btn-with-logo back-btn">
								<ion-icon name="close-outline"></ion-icon>
								Annuler
							</a>
							<button type="submit" class="custom-btn-with-logo edit-btn">
								<ion-icon name="checkmark-outline"></ion-icon>
								Mettre à jour
							</button>
						</div>
					</div>

					{{ form_end(form) }}
				</div>
			</div>
		</div>
	</div>

	<script id="edit-product-script">
		document.addEventListener('DOMContentLoaded', initImageUpload);
		document.addEventListener('turbo:load', initImageUpload);
		document.addEventListener('turbo:frame-load', initImageUpload);

		function initImageUpload() {
		    if (!window.location.pathname.includes('/edit/')) return;
		    if (window.editImageUploadInitialized) return;
		    window.editImageUploadInitialized = true;

		    const fileInput = document.querySelector('input[type="file"]');
		    const dropZone = document.getElementById('image-drop-zone');
		    if (!fileInput || !dropZone) return;

		    const removeFlag = document.getElementById('remove-image-flag');
		    const currentImage = document.getElementById('current-image');
		    const uploadPlaceholder = document.getElementById('upload-placeholder');
		    const imagePreview = document.getElementById('image-preview');
		    const previewImg = document.getElementById('preview-img');
		    const imageName = document.getElementById('image-name');

		    const showImageState = state => {
		        currentImage?.classList.toggle('hidden', state !== 'current');
		        uploadPlaceholder?.classList.toggle('hidden', state !== 'placeholder');
		        imagePreview?.classList.toggle('hidden', state !== 'preview');
		    };

		    const clearPreview = () => {
		        previewImg.src = '';
		        imageName.textContent = '';
		        fileInput.value = '';
		    };

		    const showImagePreview = file => {
		        removeFlag.value = '0';
		        const reader = new FileReader();
		        reader.onload = e => {
		            previewImg.src = e.target.result;
		            imageName.textContent = file.name;
		            showImageState('preview');
		        };
		        reader.readAsDataURL(file);
		    };

		    // Events
		    dropZone.addEventListener('click', e => {
		        if (!e.target.closest('button')) fileInput.click();
		    });

		    fileInput.addEventListener('change', e => {
		        if (e.target.files.length) showImagePreview(e.target.files[0]);
		    });

		    dropZone.addEventListener('dragover', e => {
		        e.preventDefault();
		        dropZone.classList.add('border-blue-400', 'bg-blue-50');
		    });

		    dropZone.addEventListener('dragleave', e => {
		        e.preventDefault();
		        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
		    });

		    dropZone.addEventListener('drop', e => {
		        e.preventDefault();
		        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
		        if (e.dataTransfer.files.length) {
		            fileInput.files = e.dataTransfer.files;
		            showImagePreview(e.dataTransfer.files[0]);
		        }
		    });

		    document.getElementById('remove-image-completely')?.addEventListener('click', () => {
		        removeFlag.value = '1';
		        clearPreview();
		        showImageState('placeholder');
		    });

		    document.getElementById('cancel-modification')?.addEventListener('click', () => {
		        removeFlag.value = '0';
		        clearPreview();
		        showImageState('current');
		    });

		    document.getElementById('remove-current-image')?.addEventListener('click', () => {
		        removeFlag.value = '1';
		        clearPreview();
		        showImageState('placeholder');
		    });

		    // Récupération après erreur de validation
		    if (fileInput.files.length) {
		        showImagePreview(fileInput.files[0]);
		    }
		}
	</script>

{% endblock %}
